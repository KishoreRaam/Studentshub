name: Daily Perks Update

on:
  schedule:
    - cron: '30 0 * * *' # 00:30 UTC = 06:00 IST
  workflow_dispatch: # Manual trigger

permissions:
  contents: write
  issues: write

jobs:
  update-perks:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Check perk links
        run: node scripts/automation/check-perk-links.js

      - name: Discover new perks
        run: node scripts/automation/discover-new-perks.js

      - name: Check for CSV changes
        id: csv-changes
        run: |
          if git diff --quiet -- 'public/assets/*.csv'; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push CSV changes
        if: steps.csv-changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/assets/*.csv
          git commit -m "chore: update perk link health status [automated]"
          git push

      - name: Check for new staged perks
        id: new-perks
        run: |
          STAGING_FILES=$(find scripts/automation/staging -name '*.csv' -newer scripts/automation/staging/.gitkeep 2>/dev/null | head -1)
          if [ -n "$STAGING_FILES" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "file=$STAGING_FILES" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for new perks
        if: steps.new-perks.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STAGING_FILE="${{ steps.new-perks.outputs.file }}"
          PERK_COUNT=$(tail -n +2 "$STAGING_FILE" | wc -l)
          PERK_LIST=$(tail -n +2 "$STAGING_FILE" | cut -d',' -f1 | head -20 | sed 's/^/- /')

          gh issue create \
            --title "New student perks discovered ($PERK_COUNT found)" \
            --body "$(cat <<EOF
          ## New Perks Discovered

          The automated discovery script found **$PERK_COUNT** new potential student perks.

          ### Perks Found
          $PERK_LIST

          ### Next Steps
          1. Review the staging file: \`$STAGING_FILE\`
          2. Fill in missing category, description, and verification fields
          3. Move approved perks to the main CSV
          4. Close this issue when done

          *Generated by the Daily Perks Update workflow*
          EOF
          )"
